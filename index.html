<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>Gemini Modern Chat (Light)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <style>
    :root {
      --bg-body: #f3f4f6;
      --bg-panel: #f9fafb;
      --bg-chat: #ffffff;
      --border-soft: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --accent-soft-strong: rgba(37, 99, 235, 0.16);
      --text-main: #111827;
      --text-muted: #6b7280;
      --bubble-user: linear-gradient(135deg, #2563eb, #3b82f6);
      --bubble-ai: #f9fafb;
      --radius-xl: 24px;
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, rgba(191, 219, 254, 0.6), transparent 55%),
        radial-gradient(circle at bottom, rgba(219, 234, 254, 0.6), transparent 60%),
        var(--bg-body);
      color: var(--text-main);
    }

    /* APP SHELL */
    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }

    .app-main {
      flex: 1;
      display: flex;
      gap: 16px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    /* LEFT PANEL (SIDEBAR) */
    .sidebar {
      flex: 0 0 290px;
      background: radial-gradient(circle at top left, #ffffff, #f9fafb);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-soft);
      padding: 18px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 10% -10%, #eff6ff, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #111827;
      font-size: 18px;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.5);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .brand-text span:first-child {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .brand-text span:last-child {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
    }

    .pill-badge {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(22, 163, 74, 0.4);
      background: rgba(34, 197, 94, 0.08);
      color: #166534;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.35);
    }

    .sidebar-section-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    /* CONTROLS */
    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .control-btn {
      flex: 1 1 auto;
      font-size: 0.82rem;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      color: #111827;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .control-btn span.emoji {
      font-size: 1rem;
    }

    .control-btn:hover {
      border-color: var(--accent);
      background: #eff6ff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .control-btn.danger {
      border-color: rgba(248, 113, 113, 0.7);
      color: #b91c1c;
      background: #fef2f2;
    }

    .control-btn.danger:hover {
      background: #fee2e2;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.6);
    }

    /* SUGGESTIONS */
    .suggestions-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 18px;
      background: #ffffff;
      border: 1px dashed var(--border-soft);
    }

    .suggestions-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .suggestions-header small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .refresh-suggestions-btn {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: none;
      background: #eff6ff;
      color: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      white-space: nowrap;
    }

    .refresh-suggestions-btn:hover {
      background: #dbeafe;
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      max-height: 190px;
      overflow-y: auto;
    }

    .suggestion-chip {
      border-radius: 999px;
      font-size: 0.75rem;
      padding: 6px 9px;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
      color: #111827;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      max-width: 100%;
    }

    .suggestion-chip:hover {
      border-color: var(--accent);
      background: #eff6ff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .sidebar-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      padding-top: 6px;
      border-top: 1px solid var(--border-soft);
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .model-pill {
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
      padding: 4px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .model-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.3);
    }

    /* MAIN CHAT PANEL */
    .chat-panel {
      flex: 1;
      background: radial-gradient(circle at top left, #ffffff, #f9fafb);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
    }

    .chat-header-modern {
      padding: 14px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(to right, #eff6ff, #ffffff);
    }

    .chat-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #111827;
    }

    .chat-title span.logo-mini {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 20% -20%, #eff6ff, #2563eb);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #111827;
      font-weight: 700;
    }

    .chat-title small {
      font-size: 0.68rem;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .chat-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .chat-header-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
    }

    .chip-soft {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    /* CHAT BODY */
    .chat-body-modern {
      flex: 1;
      padding: 12px 14px 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
      background: var(--bg-panel);
    }

    .chat-greeting-card {
      margin: 4px auto 10px;
      max-width: 520px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 18px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .greeting-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 10% -10%, #eff6ff, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #111827;
      font-weight: 700;
      flex-shrink: 0;
    }

    .greeting-text h2 {
      font-size: 0.98rem;
      font-weight: 600;
      margin: 0 0 4px;
    }

    .greeting-text p {
      font-size: 0.8rem;
      margin: 0;
      color: var(--text-muted);
    }

    /* CHAT BOX (scroll only here) */
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 6px 4px 10px;
      margin: 0 auto;
      width: 100%;
      max-width: 720px;
      max-height: 70vh;
    }

    .chat-bubble-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 10px;
    }

    .chat-bubble-row.user {
      justify-content: flex-end;
    }

    .chat-bubble {
      max-width: 100%;
      border-radius: 18px;
      padding: 9px 12px;
      font-size: 0.92rem;
      line-height: 1.55;
      border: 1px solid transparent;
      white-space: pre-wrap;
    }

    .chat-bubble-user {
      background-image: var(--bubble-user);
      color: #eff6ff;
      border-color: rgba(37, 99, 235, 0.9);
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.35);
    }

    .ai-message-wrapper {
      position: relative;
      max-width: 100%;
      flex: 1;
    }

    .chat-bubble-ai {
      background-color: var(--bubble-ai);
      border-color: var(--border-soft);
      color: #111827;
      box-shadow: 0 10px 24px rgba(148, 163, 184, 0.25);
    }

    .ai-copy-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      border: none;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      background: rgba(243, 244, 246, 0.9);
      color: #4b5563;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .ai-message-wrapper:hover .ai-copy-btn {
      opacity: 1;
    }

    .ai-copy-btn:hover {
      background: #e5e7eb;
    }

    .ai-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 10% -10%, #eff6ff, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-size: 0.78rem;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.6);
    }

    /* LOADING PLACEHOLDER */
    .ai-placeholder-lines {
      display: inline-flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
    }

    .ai-placeholder-line {
      height: 9px;
      border-radius: 999px;
      background: linear-gradient(
        90deg,
        rgba(209, 213, 219, 0.6),
        rgba(156, 163, 175, 0.6),
        rgba(209, 213, 219, 0.6)
      );
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite ease-in-out;
    }

    .ai-placeholder-line:nth-child(2) {
      width: 80%;
    }

    .ai-placeholder-line:nth-child(3) {
      width: 60%;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* INPUT AREA */
    .chat-input-container {
      border-top: 1px solid #e5e7eb;
      padding: 10px 14px 12px;
      background: #ffffff;
    }

    .chat-input-inner {
      max-width: 720px;
      margin: 0 auto;
      background: #f9fafb;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 14px;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .chat-input-inner:focus-within {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(37, 99, 235, 0.3),
        0 12px 30px rgba(148, 163, 184, 0.3);
    }

    .chat-input-prefix {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-input-prefix span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    #prompt {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: #111827;
      font-size: 0.9rem;
      padding: 6px 0;
    }

    #prompt::placeholder {
      color: #9ca3af;
    }

    .btn-send {
      border-radius: 999px;
      min-width: 90px;
      padding: 6px 12px;
      font-size: 0.86rem;
      font-weight: 500;
      border: none;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: #eff6ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow:
        0 12px 30px rgba(37, 99, 235, 0.4),
        0 0 0 1px rgba(30, 64, 175, 0.25);
    }

    .btn-send:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .btn-send:hover:not(:disabled) {
      filter: brightness(1.05);
      transform: translateY(-0.5px);
    }

    .footer-meta {
      max-width: 720px;
      margin: 6px auto 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      min-width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      font-size: 0.72rem;
      font-family: inherit;
      color: #111827;
    }

    .status-text {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-spinner {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(209, 213, 219, 0.9);
      border-top-color: var(--accent);
      animation: spin 0.7s linear infinite;
      display: none;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* SCROLLBAR */
    #chat-box::-webkit-scrollbar,
    .suggestions::-webkit-scrollbar {
      width: 6px;
    }

    #chat-box::-webkit-scrollbar-thumb,
    .suggestions::-webkit-scrollbar-thumb {
      background-color: #cbd5f5;
      border-radius: 999px;
    }

    /* RESPONSIVE */
    @media (max-width: 992px) {
      .app-main {
        flex-direction: column;
      }

      .sidebar {
        flex: 0 0 auto;
        order: 2;
      }

      .chat-panel {
        order: 1;
      }
    }

    @media (max-width: 575.98px) {
      .app-shell {
        padding: 10px;
      }

      .sidebar {
        border-radius: 18px;
      }

      .chat-panel {
        border-radius: 18px;
      }

      .chat-header-modern {
        padding-inline: 12px;
      }

      .chat-input-inner {
        border-radius: 18px;
      }

      .chat-body-modern {
        padding-inline: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <div class="app-main">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="brand-pill">
            <div class="brand-icon">G</div>
            <div class="brand-text">
              <span>Personal AI assistant</span>
              <span>Gemini Chatboard</span>
            </div>
          </div>
          <div class="pill-badge">
            <span class="pill-dot"></span>
            Live
          </div>
        </div>

        <div>
          <div class="sidebar-section-title">Quick actions</div>
          <div class="control-group">
            <button id="newChatBtn" type="button" class="control-btn">
              <span class="emoji">âœ¨</span>
              <span>New chat / Restart</span>
            </button>
            <button id="clearHistoryBtn" type="button" class="control-btn danger">
              <span class="emoji">ðŸ§¹</span>
              <span>Hapus history</span>
            </button>
          </div>
        </div>

        <div class="suggestions-wrapper">
          <div class="suggestions-header">
            <small>Rekomendasi pertanyaan</small>
            <button id="refreshSuggestions" type="button" class="refresh-suggestions-btn">
              <span>Acak</span> <span>âŸ³</span>
            </button>
          </div>
          <div id="suggestions" class="suggestions">
            <!-- Dynamic -->
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="model-pill">
            <span class="model-dot"></span>
            <span id="model-name">gemini-2.5-flash</span>
          </div>
          <div class="text-end">
            <div>Session-based</div>
            <div>History: <span id="history-count">0</span> pesan</div>
          </div>
        </div>
      </aside>

      <!-- CHAT PANEL -->
      <section class="chat-panel">
        <!-- HEADER -->
        <header class="chat-header-modern">
          <div class="chat-title-block">
            <div class="chat-title">
              <span class="logo-mini">G</span>
              <span>Gemini Chat</span>
              <small>Modern workspace</small>
            </div>
            <div class="chat-subtitle">
              Tanyakan apa saja â€” pekerjaan, code, ide, atau hal random lain. Saya akan coba bantu sebaik mungkin.
            </div>
          </div>
          <div class="chat-header-meta">
            <div class="chip-soft">
              <span class="status-dot"></span>
              <span>Status: Ready</span>
            </div>
          </div>
        </header>

        <!-- BODY -->
        <main class="chat-body-modern">
          <div id="greetingCard" class="chat-greeting-card">
            <div class="greeting-icon">AI</div>
            <div class="greeting-text">
              <h2>Selamat datang ðŸ‘‹</h2>
              <p>
                Saya Gemini, asisten AI kamu. Tulis apa yang ingin kamu kerjakan atau tanyakan,
                dan saya akan bantu merangkai jawaban, ide, atau solusi yang lebih rapih.
              </p>
            </div>
          </div>

          <div id="chat-box">
            <!-- Messages -->
          </div>
        </main>

        <!-- INPUT -->
        <footer class="chat-input-container">
          <div class="chat-input-inner">
            <div class="chat-input-prefix">
              <span class="icon">âŒ¨</span>
              <span class="d-none d-md-inline">Tulis pesan...</span>
            </div>
            <input
              id="prompt"
              autocomplete="off"
              placeholder="Tulis pertanyaan atau instruksi kamu di sini..."
            />
            <button id="sendBtn" class="btn-send" type="button">
              <span id="sendLabel">Kirim</span>
              <span id="sendSpinner" class="status-spinner" aria-hidden="true"></span>
            </button>
          </div>
          <div class="footer-meta">
            <span>Tekan <span class="kbd">Enter</span> untuk kirim, <span class="kbd">Shift</span> + <span class="kbd">Enter</span> untuk baris baru.</span>
            <span class="status-text">
              <span id="statusText">Menyiapkan saran...</span>
            </span>
          </div>
        </footer>
      </section>
    </div>
  </div>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Gemini + Chat Logic -->
  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const API_KEY = "AIzaSyBlyZScLwO6NnvfqiInNf2saHFajvI4-N8"; // ganti dengan API key kamu
    const MODEL_NAME = "gemini-2.5-flash";
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: MODEL_NAME });

    const HISTORY_KEY = "gemini_modern_chat_history_v1";

    const chatBox = document.getElementById("chat-box");
    const promptInput = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const sendSpinner = document.getElementById("sendSpinner");
    const sendLabel = document.getElementById("sendLabel");
    const statusText = document.getElementById("statusText");
    const suggestionsBox = document.getElementById("suggestions");
    const refreshSuggestionsBtn = document.getElementById("refreshSuggestions");
    const modelNameLabel = document.getElementById("model-name");
    const historyCountLabel = document.getElementById("history-count");
    const greetingCard = document.getElementById("greetingCard");
    const newChatBtn = document.getElementById("newChatBtn");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    modelNameLabel.textContent = MODEL_NAME;

    let isSending = false;
    let conversationHistory = [];

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateHistoryCount() {
      historyCountLabel.textContent = conversationHistory.length.toString();
    }

    function saveHistory() {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(conversationHistory));
      } catch (e) {
        console.warn("Gagal menyimpan history:", e);
      }
      updateHistoryCount();
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Gagal membaca history:", e);
        return [];
      }
    }

    function clearHistory() {
      conversationHistory = [];
      try {
        localStorage.removeItem(HISTORY_KEY);
      } catch (e) {
        console.warn("Gagal clear history:", e);
      }
      updateHistoryCount();
    }

    function setSendingState(sending) {
      isSending = sending;
      sendBtn.disabled = sending;
      if (sending) {
        sendSpinner.style.display = "inline-block";
        sendLabel.textContent = "Mengirim...";
        statusText.textContent = "AI sedang memikirkan jawaban...";
      } else {
        sendSpinner.style.display = "none";
        sendLabel.textContent = "Kirim";
        statusText.textContent = "Siap membantu âœ¨";
      }
    }

    function sanitizeText(text) {
      if (!text) return "";
      return text.replace(/\*\*/g, "");
    }

    function typeText(element, text, onComplete) {
      const clean = sanitizeText(text);
      element.textContent = "";
      const chars = Array.from(clean);
      let index = 0;
      const speed = 15;

      const interval = setInterval(() => {
        if (index >= chars.length) {
          clearInterval(interval);
          if (typeof onComplete === "function") onComplete();
          return;
        }
        element.textContent += chars[index];
        index++;
        scrollToBottom();
      }, speed);
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        statusText.textContent = "Tersalin ke clipboard âœ…";
      } catch (e) {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); } catch {}
        document.body.removeChild(ta);
        statusText.textContent = "Tersalin (fallback) âœ…";
      }
    }

    function addMessage(role, text, { isLoading = false, animate = false } = {}) {
      const row = document.createElement("div");
      const isUser = role === "user";
      row.className = "chat-bubble-row " + (isUser ? "user" : "ai");

      const cleanText = sanitizeText(text);

      if (isUser) {
        const bubble = document.createElement("div");
        bubble.className = "chat-bubble chat-bubble-user";
        bubble.textContent = cleanText;
        row.appendChild(bubble);
        chatBox.appendChild(row);
        scrollToBottom();
        return { row, bubble };
      } else {
        const avatar = document.createElement("div");
        avatar.className = "ai-avatar";
        avatar.textContent = "AI";

        const wrapper = document.createElement("div");
        wrapper.className = "ai-message-wrapper";

        const bubble = document.createElement("div");
        bubble.className = "chat-bubble chat-bubble-ai";

        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "ai-copy-btn";
        copyBtn.innerHTML = `<span>ðŸ“‹</span><span>Copy</span>`;
        copyBtn.addEventListener("click", () => {
          copyToClipboard(bubble.textContent || cleanText);
        });

        if (isLoading) {
          bubble.innerHTML = `
            <div class="ai-placeholder-lines">
              <div class="ai-placeholder-line"></div>
              <div class="ai-placeholder-line"></div>
              <div class="ai-placeholder-line"></div>
            </div>
          `;
        } else if (animate) {
          typeText(bubble, cleanText);
        } else {
          bubble.textContent = cleanText;
        }

        wrapper.appendChild(bubble);
        wrapper.appendChild(copyBtn);

        row.appendChild(avatar);
        row.appendChild(wrapper);
        chatBox.appendChild(row);
        scrollToBottom();
        return { row, bubble };
      }
    }

    function renderHistory() {
      chatBox.innerHTML = "";
      if (!conversationHistory.length) {
        greetingCard.style.display = "flex";
        return;
      }
      greetingCard.style.display = "none";

      for (const msg of conversationHistory) {
        addMessage(msg.role, msg.text, { isLoading: false, animate: false });
      }
      scrollToBottom();
    }

    function resetChat({ keepSuggestions = true } = {}) {
      clearHistory();
      chatBox.innerHTML = "";
      greetingCard.style.display = "flex";
      if (!keepSuggestions) {
        loadSuggestions();
      }
      statusText.textContent = "Mulai percakapan baru âœ¨";
    }

    async function loadSuggestions() {
      suggestionsBox.innerHTML =
        `<span class="text-muted small">Mengambil saran dari AI...</span>`;

      try {
        const promptForSuggestions = `
          Buat 10 contoh pertanyaan singkat dan variatif dalam bahasa Indonesia
          yang cocok untuk diajukan ke asisten AI seputar:
          - pekerjaan & produktivitas,
          - pemrograman / teknologi,
          - pengembangan diri,
          - ide kreatif.

          Jawab hanya dengan list poin tanpa nomor, satu pertanyaan per baris.
        `;

        const result = await model.generateContent(promptForSuggestions);
        const text = result.response.text();

        let lines = text
          .split(/\r?\n/)
          .map((l) => l.replace(/^[-*\d.\s]+/, "").trim())
          .filter((l) => l.length > 0)
          .map(sanitizeText);

        if (!lines.length) {
          throw new Error("Respons kosong dari model.");
        }

        lines = lines.sort(() => Math.random() - 0.5);
        const selected = lines.slice(0, 6);

        suggestionsBox.innerHTML = "";
        selected.forEach((item) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "suggestion-chip";
          btn.textContent = item;
          btn.onclick = () => {
            promptInput.value = item;
            sendMessage();
          };
          suggestionsBox.appendChild(btn);
        });

        statusText.textContent = "Siap membantu âœ¨";
      } catch (error) {
        console.error(error);
        suggestionsBox.innerHTML =
          `<span class="text-danger small">Gagal memuat saran. Klik "Acak" untuk coba lagi.</span>`;
        statusText.textContent = "Gagal memuat saran awal.";
      }
    }

    async function sendMessage() {
      const prompt = promptInput.value.trim();
      if (!prompt || isSending) return;

      setSendingState(true);
      greetingCard.style.display = "none";

      addMessage("user", prompt);
      conversationHistory.push({ role: "user", text: prompt });
      saveHistory();
      promptInput.value = "";

      const { bubble } = addMessage("ai", "", { isLoading: true });

      try {
        const result = await model.generateContent(prompt);
        const reply = result.response.text();
        const cleanReply = sanitizeText(reply);

        conversationHistory.push({ role: "ai", text: cleanReply });
        saveHistory();

        bubble.innerHTML = "";
        typeText(bubble, cleanReply, () => {
          statusText.textContent = "Siap membantu âœ¨";
        });

        if (Math.random() < 0.25) {
          loadSuggestions();
        }
      } catch (err) {
        console.error(err);
        bubble.innerHTML = "";
        bubble.textContent = "âŒ Terjadi kesalahan: " + err.message;
        statusText.textContent = "Terjadi kesalahan. Coba kirim ulang.";
      } finally {
        setSendingState(false);
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    refreshSuggestionsBtn.addEventListener("click", () => {
      loadSuggestions();
    });

    newChatBtn.addEventListener("click", () => {
      resetChat({ keepSuggestions: false });
    });

    clearHistoryBtn.addEventListener("click", () => {
      clearHistory();
      renderHistory();
      statusText.textContent = "History chat dihapus.";
    });

    (function init() {
      statusText.textContent = "Menyiapkan saran dari AI...";
      conversationHistory = loadHistory();
      updateHistoryCount();
      renderHistory();
      loadSuggestions();
    })();
  </script>
</body>

</html>
