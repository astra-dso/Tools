<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>PDF Tools - Frontend Only</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- pdf-lib (manipulasi PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

    <!-- pdf.js (GLOBAL, bukan module) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
    <script>
        // WAJIB: kasih tau lokasi worker pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="min-h-screen flex items-start justify-center">
    <div class="max-w-7xl w-full px-4 sm:px-8 py-8 space-y-6">

        <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-semibold text-slate-800">
                    PDF Tools (Frontend Only)
                </h1>
                <p class="text-xs text-slate-500 mt-1">
                    Semua proses berjalan di browser. Tidak butuh server.
                </p>
            </div>
        </header>

        <div class="grid lg:grid-cols-[260px,1fr] gap-6">
            <!-- SIDEBAR TOOLS -->
            <aside class="space-y-4">
                <div>
                    <h2 class="text-xs font-semibold tracking-wide text-slate-500 mb-2">
                        ATUR PDF
                    </h2>
                    <div class="space-y-2">
                        <button class="tool-card" data-tool="merge">
                            <span class="tool-icon bg-red-500">+</span>
                            <div>
                                <div class="tool-title">Gabungkan PDF</div>
                                <div class="tool-desc">Satukan beberapa PDF jadi satu.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="split">
                            <span class="tool-icon bg-red-500">â‡£</span>
                            <div>
                                <div class="tool-title">Pisahkan / Ekstrak</div>
                                <div class="tool-desc">Ambil halaman tertentu dari PDF.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="deletePages">
                            <span class="tool-icon bg-red-500">âœ•</span>
                            <div>
                                <div class="tool-title">Hapus Halaman</div>
                                <div class="tool-desc">Buang halaman yang tidak perlu.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="reorder">
                            <span class="tool-icon bg-red-500">â˜°</span>
                            <div>
                                <div class="tool-title">Atur Urutan</div>
                                <div class="tool-desc">Ubah urutan halaman PDF.</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-semibold tracking-wide text-slate-500 mb-2">
                        EDIT PDF
                    </h2>
                    <div class="space-y-2">
                        <button class="tool-card" data-tool="rotate">
                            <span class="tool-icon bg-pink-500">â†»</span>
                            <div>
                                <div class="tool-title">Putar PDF</div>
                                <div class="tool-desc">Putar semua halaman sekaligus.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="pageNumbers">
                            <span class="tool-icon bg-pink-500">#</span>
                            <div>
                                <div class="tool-title">Nomor Halaman</div>
                                <div class="tool-desc">Tambahkan nomor di setiap halaman.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="watermark">
                            <span class="tool-icon bg-pink-500">ðŸ’§</span>
                            <div>
                                <div class="tool-title">Watermark Teks</div>
                                <div class="tool-desc">Watermark diagonal di semua halaman.</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-semibold tracking-wide text-slate-500 mb-2">
                        KONVERSI
                    </h2>
                    <div class="space-y-2">
                        <button class="tool-card" data-tool="imagesToPdf">
                            <span class="tool-icon bg-yellow-500">IMG</span>
                            <div>
                                <div class="tool-title">Gambar â†’ PDF</div>
                                <div class="tool-desc">JPG/PNG jadi satu file PDF.</div>
                            </div>
                        </button>
                        <button class="tool-card" data-tool="pdfToImages">
                            <span class="tool-icon bg-yellow-500">PDF</span>
                            <div>
                                <div class="tool-title">PDF â†’ PNG</div>
                                <div class="tool-desc">Setiap halaman jadi gambar.</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-semibold tracking-wide text-slate-500 mb-2">
                        OPTIMALKAN
                    </h2>
                    <div class="space-y-2">
                        <button class="tool-card" data-tool="compress">
                            <span class="tool-icon bg-emerald-500">â¬‡</span>
                            <div>
                                <div class="tool-title">Kompres Ringan</div>
                                <div class="tool-desc">Re-save PDF (kadang lebih kecil).</div>
                            </div>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- MAIN TOOL PANEL -->
            <main class="space-y-4">
                <!-- Panel utama yang akan diisi JS -->
                <section id="toolPanel"
                         class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 sm:p-6">
                    <h2 class="text-lg font-semibold text-slate-800 mb-2">
                        Pilih tool di sebelah kiri
                    </h2>
                    <p class="text-sm text-slate-500">
                        Setelah memilih tool, langkah-langkah dan form akan muncul di sini.
                        Preview PDF juga akan tampil otomatis ketika Anda memilih file.
                    </p>
                </section>

                <!-- PREVIEW & LOG -->
                <section class="grid md:grid-cols-[minmax(0,2fr),minmax(0,1.3fr)] gap-4">
                    <!-- PREVIEW -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-slate-800">Preview</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-500">
                                Halaman pertama + info file
                            </span>
                        </div>
                        <div class="flex flex-col items-center">
                            <canvas id="pdfPreviewCanvas"
                                    class="border border-dashed border-slate-300 rounded-lg bg-slate-50 max-w-full"></canvas>
                            <div id="pdfPreviewMeta"
                                 class="mt-3 text-xs text-slate-600 text-center">
                                Belum ada file yang dipilih.
                            </div>
                        </div>
                    </div>

                    <!-- LOG -->
                    <div class="bg-slate-900 text-slate-100 rounded-2xl p-4 shadow-sm text-xs">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold">Log Proses</h3>
                            <button id="clearLog"
                                    class="text-[10px] px-2 py-0.5 rounded-full border border-slate-500/50 hover:bg-slate-800">
                                Clear
                            </button>
                        </div>
                        <div id="logContent"
                             class="space-y-1 max-h-64 overflow-auto text-[11px] leading-relaxed">
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
</div>

<!-- STYLE KECIL UNTUK CARD TOOL -->
<style>
    .tool-card {
        @apply w-full flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-left text-xs hover:border-indigo-400 hover:shadow-sm transition;
    }
    .tool-icon {
        @apply inline-flex items-center justify-center w-7 h-7 rounded text-[11px] font-semibold text-white;
    }
    .tool-title {
        @apply text-[13px] font-semibold text-slate-800;
    }
    .tool-desc {
        @apply text-[11px] text-slate-500;
    }
    .tool-card.active {
        @apply border-indigo-500 ring-2 ring-indigo-200 bg-indigo-50/60;
    }
</style>

<!-- JS LOGIKA + PREVIEW + FUNGSI TOOLS -->
<script>
    // ====== UTIL ======
    const logBox = document.getElementById('logContent');
    const clearLogBtn = document.getElementById('clearLog');
    clearLogBtn.addEventListener('click', () => {
        logBox.innerHTML = '';
    });

    function log(msg) {
        const row = document.createElement('div');
        row.textContent = `${new Date().toLocaleTimeString()}  â€¢  ${msg}`;
        logBox.prepend(row);
    }

    function downloadBytes(bytes, filename, mime) {
        const blob = new Blob([bytes], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Preview PDF (halaman 1) pakai pdfjsLib global
    async function previewPdfFile(file) {
        const canvas = document.getElementById('pdfPreviewCanvas');
        const meta = document.getElementById('pdfPreviewMeta');

        if (!file) {
            canvas.width = canvas.height = 0;
            meta.textContent = 'Belum ada file yang dipilih.';
            return;
        }

        try {
            const buffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: buffer });
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);
            const scale = 0.9;
            const viewport = page.getViewport({ scale });

            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: ctx, viewport }).promise;

            meta.innerHTML = `
                <div><strong>${file.name}</strong></div>
                <div class="mt-1">
                    <span>Halaman: ${pdf.numPages}</span> Â·
                    <span>Ukuran: ${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `;
            log(`Preview PDF: ${file.name} (${pdf.numPages} halaman)`);
        } catch (e) {
            console.error(e);
            meta.textContent = 'Gagal menampilkan preview PDF.';
            log('ERROR preview PDF: ' + e.message);
        }
    }

    function loadPdfFromInput(inputId, cb) {
        const input = document.getElementById(inputId);
        input.addEventListener('change', async () => {
            const file = input.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                alert('File harus PDF.');
                return;
            }
            await previewPdfFile(file);
            cb(file);
        });
    }

    const toolPanel = document.getElementById('toolPanel');

    // ====== SEMUA TOOL FRONTEND-ONLY ======
    const tools = {
        merge() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Gabungkan PDF</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Pilih beberapa file PDF, urutan sesuai urutan pilih. Hasil akan menjadi satu file PDF.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih beberapa PDF
                        </label>
                        <input id="mergeFiles" type="file" accept="application/pdf" multiple
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                        <p class="text-[11px] text-slate-400">
                            Klik salah satu file di daftar untuk melihat preview-nya.
                        </p>
                    </div>

                    <div id="mergeList" class="border border-dashed border-slate-300 rounded-lg p-2 text-[11px] text-slate-600 bg-slate-50 min-h-[40px]">
                        Belum ada file dipilih.
                    </div>

                    <button id="mergeRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500 text-white text-xs font-semibold hover:bg-red-600">
                        Gabungkan PDF
                    </button>
                </div>
            `;

            const input = document.getElementById('mergeFiles');
            const list = document.getElementById('mergeList');

            input.addEventListener('change', async () => {
                const files = Array.from(input.files || []);
                if (!files.length) {
                    list.textContent = 'Belum ada file dipilih.';
                    return;
                }
                list.innerHTML = '';
                files.forEach((f, idx) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'block w-full text-left px-2 py-1 rounded hover:bg-slate-200';
                    btn.textContent = `${idx + 1}. ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)`;
                    btn.addEventListener('click', () => previewPdfFile(f));
                    list.appendChild(btn);
                });
                await previewPdfFile(files[0]);
            });

            document.getElementById('mergeRun').addEventListener('click', async () => {
                const files = Array.from(input.files || []);
                if (files.length < 2) {
                    alert('Pilih minimal 2 file PDF.');
                    return;
                }

                log(`Menggabungkan ${files.length} PDF...`);
                const mergedPdf = await PDFLib.PDFDocument.create();

                for (const file of files) {
                    const bytes = await file.arrayBuffer();
                    const pdf = await PDFLib.PDFDocument.load(bytes);
                    const copied = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copied.forEach(p => mergedPdf.addPage(p));
                }

                const mergedBytes = await mergedPdf.save();
                downloadBytes(mergedBytes, 'merged.pdf', 'application/pdf');
                log('Selesai: merged.pdf');
            });
        },

        split() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Pisahkan / Ekstrak Halaman</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Ambil halaman tertentu dari sebuah PDF dan simpan sebagai file baru.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="splitFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                        <p class="text-[11px] text-slate-400">
                            Preview akan muncul di panel kanan.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            2. Masukkan halaman yang ingin diambil
                        </label>
                        <input id="splitPages" type="text"
                               placeholder="contoh: 1-3 atau 1,3,5"
                               class="w-full border border-slate-200 rounded-lg px-2 py-1.5 text-xs bg-white" />
                        <p class="text-[11px] text-slate-400">
                            Bisa pakai range (<code>1-3</code>) dan list (<code>1,4,6</code>) sekaligus.
                        </p>
                    </div>

                    <button id="splitRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500 text-white text-xs font-semibold hover:bg-red-600">
                        Ekstrak Halaman
                    </button>
                </div>
            `;

            let currentFile = null;

            loadPdfFromInput('splitFile', (file) => { currentFile = file; });

            document.getElementById('splitRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');

                const spec = document.getElementById('splitPages').value.trim();
                if (!spec) return alert('Isi halaman yang ingin diambil.');

                const parsePages = (spec, max) => {
                    const set = new Set();
                    spec.split(',').forEach(part => {
                        part = part.trim();
                        if (!part) return;
                        if (part.includes('-')) {
                            let [a, b] = part.split('-').map(n => parseInt(n, 10));
                            if (isNaN(a) || isNaN(b)) return;
                            if (a > b) [a, b] = [b, a];
                            for (let i = a; i <= b; i++) if (i >= 1 && i <= max) set.add(i - 1);
                        } else {
                            const n = parseInt(part, 10);
                            if (!isNaN(n) && n >= 1 && n <= max) set.add(n - 1);
                        }
                    });
                    return Array.from(set).sort((x, y) => x - y);
                };

                log('Memuat PDF untuk ekstrak...');
                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const total = pdf.getPageCount();
                const pageIdx = parsePages(spec, total);
                if (!pageIdx.length) return alert('Tidak ada halaman valid dari input.');

                const out = await PDFLib.PDFDocument.create();
                const copied = await out.copyPages(pdf, pageIdx);
                copied.forEach(p => out.addPage(p));
                const outBytes = await out.save();
                downloadBytes(outBytes, 'extracted_pages.pdf', 'application/pdf');
                log('Halaman diekstrak: ' + pageIdx.map(i => i + 1).join(', '));
            });
        },

        deletePages() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Hapus Halaman</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Buang halaman yang tidak dibutuhkan dari sebuah PDF.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="delFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            2. Halaman yang akan dihapus
                        </label>
                        <input id="delPages" type="text"
                               placeholder="contoh: 2 atau 2,4,6"
                               class="w-full border border-slate-200 rounded-lg px-2 py-1.5 text-xs bg-white" />
                    </div>

                    <button id="delRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500 text-white text-xs font-semibold hover:bg-red-600">
                        Hapus Halaman
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('delFile', (file) => { currentFile = file; });

            document.getElementById('delRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');
                const spec = document.getElementById('delPages').value.trim();
                if (!spec) return alert('Isi halaman yang ingin dihapus.');

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const total = pdf.getPageCount();

                const delSet = new Set();
                spec.split(',').forEach(s => {
                    const n = parseInt(s.trim(), 10);
                    if (!isNaN(n) && n >= 1 && n <= total) delSet.add(n - 1);
                });

                if (!delSet.size) return alert('Input halaman tidak valid.');

                const keepIdx = [];
                for (let i = 0; i < total; i++) if (!delSet.has(i)) keepIdx.push(i);

                const out = await PDFLib.PDFDocument.create();
                const copied = await out.copyPages(pdf, keepIdx);
                copied.forEach(p => out.addPage(p));
                const outBytes = await out.save();
                downloadBytes(outBytes, 'deleted_pages.pdf', 'application/pdf');
                log('Halaman dihapus: ' + Array.from(delSet).map(i => i + 1).join(', '));
            });
        },

        reorder() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Atur Urutan Halaman</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Masukkan urutan halaman baru, misalnya <code>2,1,3,4</code>.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="ordFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            2. Urutan baru
                        </label>
                        <input id="ordSpec" type="text"
                               placeholder="contoh: 2,1,3,4"
                               class="w-full border border-slate-200 rounded-lg px-2 py-1.5 text-xs bg-white" />
                        <p class="text-[11px] text-slate-400">
                            Semua halaman harus tercantum satu kali. Misal jumlah halaman 4 â†’ masukkan kombinasi 1..4.
                        </p>
                    </div>

                    <button id="ordRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500 text-white text-xs font-semibold hover:bg-red-600">
                        Atur Urutan
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('ordFile', (file) => { currentFile = file; });

            document.getElementById('ordRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');
                const spec = document.getElementById('ordSpec').value.trim();
                if (!spec) return alert('Isi urutan halaman.');

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const total = pdf.getPageCount();

                const order = spec.split(',').map(s => parseInt(s.trim(), 10) - 1);
                if (order.length !== total || order.some(n => isNaN(n) || n < 0 || n >= total)) {
                    return alert('Urutan harus berisi semua halaman 1..' + total + ' tanpa duplikat.');
                }

                const out = await PDFLib.PDFDocument.create();
                const copied = await out.copyPages(pdf, order);
                copied.forEach(p => out.addPage(p));
                const outBytes = await out.save();
                downloadBytes(outBytes, 'reordered.pdf', 'application/pdf');
                log('Urutan baru: ' + spec);
            });
        },

        rotate() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Putar PDF</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Semua halaman akan diputar dengan sudut yang sama.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="rotFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            2. Sudut rotasi
                        </label>
                        <select id="rotAngle"
                                class="w-full border border-slate-200 rounded-lg px-2 py-1.5 text-xs bg-white">
                            <option value="90">90Â° searah jarum jam</option>
                            <option value="180">180Â°</option>
                            <option value="270">270Â°</option>
                        </select>
                    </div>

                    <button id="rotRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-pink-500 text-white text-xs font-semibold hover:bg-pink-600">
                        Putar PDF
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('rotFile', (file) => { currentFile = file; });

            document.getElementById('rotRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');
                const angle = parseInt(document.getElementById('rotAngle').value, 10);

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const pages = pdf.getPages();
                pages.forEach(p => p.setRotation(PDFLib.degrees(angle)));
                const outBytes = await pdf.save();
                downloadBytes(outBytes, 'rotated.pdf', 'application/pdf');
                log(`Semua halaman diputar ${angle}Â°.`);
            });
        },

        pageNumbers() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Nomor Halaman</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Tambahkan nomor halaman di posisi bawah-tengah.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="numFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <button id="numRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-pink-500 text-white text-xs font-semibold hover:bg-pink-600">
                        Tambah Nomor
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('numFile', (file) => { currentFile = file; });

            document.getElementById('numRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const pages = pdf.getPages();
                const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);

                pages.forEach((page, idx) => {
                    const { width } = page.getSize();
                    const text = `${idx + 1} / ${pages.length}`;
                    const fontSize = 10;
                    const textWidth = font.widthOfTextAtSize(text, fontSize);
                    page.drawText(text, {
                        x: (width - textWidth) / 2,
                        y: 20,
                        size: fontSize,
                        font,
                        color: PDFLib.rgb(0.3, 0.3, 0.3)
                    });
                });

                const outBytes = await pdf.save();
                downloadBytes(outBytes, 'page_numbers.pdf', 'application/pdf');
                log('Nomor halaman ditambahkan.');
            });
        },

        watermark() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Watermark Teks</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Watermark teks diagonal di tengah setiap halaman.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            1. Pilih PDF
                        </label>
                        <input id="wmFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            2. Teks Watermark
                        </label>
                        <input id="wmText" type="text"
                               placeholder="contoh: CONFIDENTIAL"
                               class="w-full border border-slate-200 rounded-lg px-2 py-1.5 text-xs bg-white" />
                    </div>

                    <button id="wmRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-pink-500 text-white text-xs font-semibold hover:bg-pink-600">
                        Tambah Watermark
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('wmFile', (file) => { currentFile = file; });

            document.getElementById('wmRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');
                const text = (document.getElementById('wmText').value || 'CONFIDENTIAL').trim();

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes);
                const pages = pdf.getPages();
                const font = await pdf.embedFont(PDFLib.StandardFonts.HelveticaBold);

                pages.forEach(page => {
                    const { width, height } = page.getSize();
                    const fontSize = 40;
                    const textWidth = font.widthOfTextAtSize(text, fontSize);

                    page.drawText(text, {
                        x: (width - textWidth) / 2,
                        y: height / 2,
                        size: fontSize,
                        font,
                        rotate: PDFLib.degrees(45),
                        opacity: 0.2,
                        color: PDFLib.rgb(0.7, 0, 0)
                    });
                });

                const outBytes = await pdf.save();
                downloadBytes(outBytes, 'watermarked.pdf', 'application/pdf');
                log('Watermark ditambahkan.');
            });
        },

        imagesToPdf() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Gambar â†’ PDF</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Setiap gambar (JPG/PNG) akan menjadi satu halaman di PDF.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            Pilih gambar-gambar
                        </label>
                        <input id="imgFiles" type="file" accept="image/*" multiple
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                        <p class="text-[11px] text-slate-400">
                            Urutan gambar = urutan halaman PDF.
                        </p>
                    </div>

                    <div id="imgPreview"
                         class="grid grid-cols-4 gap-2 border border-dashed border-slate-300 rounded-lg p-2 bg-slate-50 text-[11px] text-slate-500">
                        Belum ada gambar dipilih.
                    </div>

                    <button id="imgRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-yellow-500 text-white text-xs font-semibold hover:bg-yellow-600">
                        Buat PDF
                    </button>
                </div>
            `;

            const input = document.getElementById('imgFiles');
            const preview = document.getElementById('imgPreview');

            input.addEventListener('change', () => {
                const files = Array.from(input.files || []);
                if (!files.length) {
                    preview.textContent = 'Belum ada gambar dipilih.';
                    return;
                }
                preview.innerHTML = '';
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-16 object-cover rounded border border-slate-200';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            });

            document.getElementById('imgRun').addEventListener('click', async () => {
                const files = Array.from(input.files || []);
                if (!files.length) return alert('Pilih gambar dulu.');

                const pdfDoc = await PDFLib.PDFDocument.create();

                for (const file of files) {
                    const bytes = await file.arrayBuffer();
                    let img;
                    if (file.type === 'image/png') {
                        img = await pdfDoc.embedPng(bytes);
                    } else {
                        img = await pdfDoc.embedJpg(bytes);
                    }
                    const { width, height } = img;
                    const page = pdfDoc.addPage([width, height]);
                    page.drawImage(img, { x: 0, y: 0, width, height });
                }

                const outBytes = await pdfDoc.save();
                downloadBytes(outBytes, 'images_to_pdf.pdf', 'application/pdf');
                log('Gambar dikonversi ke PDF.');
            });
        },

        compress() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Kompres Ringan PDF</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Frontend hanya bisa re-save PDF, kadang ukuran sedikit lebih kecil.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            Pilih PDF
                        </label>
                        <input id="cmpFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <button id="cmpRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500 text-white text-xs font-semibold hover:bg-emerald-600">
                        Kompres Ringan
                    </button>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('cmpFile', (file) => { currentFile = file; });

            document.getElementById('cmpRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');

                const bytes = await currentFile.arrayBuffer();
                const pdf = await PDFLib.PDFDocument.load(bytes, { updateMetadata: true });
                const outBytes = await pdf.save({ useObjectStreams: true });
                downloadBytes(outBytes, 'compressed_light.pdf', 'application/pdf');
                log('PDF disimpan ulang (kompres ringan).');
            });
        },

        pdfToImages() {
            toolPanel.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">PDF â†’ PNG</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Setiap halaman akan dirender menjadi gambar PNG dan otomatis di-download.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-medium text-slate-700">
                            Pilih PDF
                        </label>
                        <input id="p2iFile" type="file" accept="application/pdf"
                               class="block w-full text-xs text-slate-600 border border-slate-200 rounded-lg px-2 py-1.5 bg-slate-50" />
                    </div>

                    <button id="p2iRun"
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-yellow-500 text-white text-xs font-semibold hover:bg-yellow-600">
                        Convert ke PNG
                    </button>
                    <p class="text-[11px] text-slate-400">
                        Catatan: untuk PDF dengan banyak halaman bisa agak lama.
                    </p>
                    <canvas id="p2iCanvas" class="hidden"></canvas>
                </div>
            `;

            let currentFile = null;
            loadPdfFromInput('p2iFile', (file) => { currentFile = file; });

            document.getElementById('p2iRun').addEventListener('click', async () => {
                if (!currentFile) return alert('Pilih file PDF dulu.');

                const arrayBuff = await currentFile.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuff });
                const pdf = await loadingTask.promise;

                const canvas = document.getElementById('p2iCanvas');
                const ctx = canvas.getContext('2d');

                log(`Render ${pdf.numPages} halaman menjadi PNG...`);

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({ canvasContext: ctx, viewport }).promise;

                    const dataUrl = canvas.toDataURL("image/png");
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = `page_${pageNum}.png`;
                    a.click();
                    log(`Halaman ${pageNum} di-download sebagai PNG.`);
                }
            });
        }
    };

    // ====== BIND MENU ======
    const toolButtons = document.querySelectorAll('.tool-card');

    toolButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const tool = btn.getAttribute('data-tool');
            toolButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (tool && tools[tool]) {
                tools[tool]();
                log('Tool dibuka: ' + tool);
            }
        });
    });
</script>

</body>
</html>
